---
- name: Provision CentOS VM for dev environment
  hosts: centos-stream-template-clone
  become: yes
  gather_facts: false
  vars:
    the_secret: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                63323537303039656137666432343531383762323331643935643634653738346332633365646266
                3138326130613735323630306139356132383734663261320a653936643032636637376565383539
                39373637623031646135326330636130383237343632633930383539306565336166636539646230
                3465343033353236350a353665326139383930366434393036306434613664623037343237333837
                36643335356137376235316236346261333865396136373064366535623930656437666261356262
                36393437653266333663643763333363373530373935333463343333353566383034646166373562
                37333366363837333439343531313761613263396134616538326661323562323437383865633135
                64316432626634303336
  tasks:
  - name: Add the user 'jboivie'
    ansible.builtin.user:
      name: jboivie
      comment: Jens B
      password: "{{ requested_password|password_hash('sha512') }}"
  - name: Create projects directory
    ansible.builtin.file:
      path: /home/jboivie/projects
      state: directory
      owner: jboivie
      mode: '0755'
  - name: Download and Install code-server
    ansible.builtin.shell:
      cmd: curl -fsSL https://code-server.dev/install.sh | sh
  - name: Enable code-server
    ansible.builtin.shell:
      cmd: systemctl enable --now code-server@jboivie
  - name: Install latest Git
    dnf:
      name: git
      state: latest
  - name: Clone this project from Git
    ansible.builtin.shell: git clone https://{{ the_secret.personal_access_token }}@github.com/forenkla/ansible-demo.git
    args:
      chdir: /home/jboivie/projects
